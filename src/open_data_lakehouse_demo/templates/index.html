{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block content %}
<header class="mb-8 border-b border-gray-700 pb-4">
    <h1 class="text-4xl font-bold text-yellow-400">Real-Time bus capacity monitoring</h1>
    <div class="text-gray-300 text-xl">
        <p>
            In this page, we can view all bus lines that are working in our city. The table below displays the buses,
            and we
            can start and stop the simulation of the buses trips.
        </p>
        <p>
            When you click the "Start Simulation" button, we will start producing Kafka messages to the `bus-updates`
            topic,
            where each message will indicate a bus coming to a stop. In the interest of time, we will speed the
            simulation
            so you can see changes in faster speeds.
        </p>
        <p>
            In order to consume and analyze the messages, we will also need to press the "Start Processing" button, that
            will launch a spark-streaming application. This application will consume the kafka messages, and send out
            some
            statistics to the front end. When we detect a bus is overfilled, the spark streaming application will also
            send
            a kafka message to the `capacity-alerts` topic.
        </p>
        <p>
            In the frontend, when a message comes in to the `capacity-alerts`, we will indicate it visually on the table
            below.
        </p>
        <p class="text-gray-200 font-bold">
            Don't forget to turn off the simulation when done, to avoid unnecessary costs!
        </p>
    </div>
</header>
<div class="mb-8 flex flex-wrap gap-4">

    <button class="bg-blue-600 hover:bg-blue-900 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105 cursor-pointer"
            id="start_spark_simulation">
        ▶️ Start Spark Buses Processing
    </button>
    <button class="bg-red-600 hover:bg-red-900 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105 cursor-pointer"
            id="stop_spark_simulation">
        ⏹️ Abort Spark Buses Processing
    </button>

    <div class="flex items-center space-x-2">
        <div id="spark-status-icon" class="w-4 h-4 rounded-full bg-gray-500"></div>
        <span id="spark-status-message-wrapper" class="text-gray-400">Processing: <span id="spark-status-message">...</span></span>
    </div>
</div>
<div class="mb-8 flex flex-wrap gap-4">
    <button class="bg-blue-600 hover:bg-blue-900 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105 cursor-pointer"
            id="start_kafka_simulation">
        ▶️ Start Kafka Buses Simulation
    </button>
    <button class="bg-red-600 hover:bg-red-900 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105 cursor-pointer"
            id="stop_kafka_simulation">
        ⏹️ Abort Kafka Buses Simulations
    </button>

    <div class="flex items-center space-x-2">
        <div id="kafka-status-icon" class="w-4 h-4 rounded-full bg-gray-500"></div>
        <span id="kafka-status-message-wrapper" class="text-gray-400">Simulation: <span id="kafka-status-message">...</span>
    </div>

</div>
<div class="bg-gray-800 shadow-2xl rounded-lg overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full" id="bus-lines-table">
            <thead class="bg-gray-700">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Bus Line
                    (ID)
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Number of
                    Stops
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Frequency
                    (Minutes)
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Updates</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Update Time</th>
            </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
            {% for bus_line in bus_lines %}
            <tr class="hover:bg-gray-700/50 transition-colors duration-200" id="bus-line-{{ bus_line.bus_line_id }}">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100">{{ bus_line.bus_line }} ({{
                    bus_line.bus_line_id }})
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-600 text-gray-100">
                                    {{ bus_line.number_of_stops }}
                                </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                    {{ bus_line.frequency_minutes }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 bus-updates"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 update-time"></td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<script type="application/javascript">
    $(document).ready(function () {
        $("button#start_spark_simulation").on("click", function (event) {
            $.post("{{ url_for('start_spark_simulation') }}").done(function (data) {
                console.log("Spark simulation started", data);
            }).fail(function (data) {
                console.log("Spark simulation started - fail", data);
            });
        });

        $("button#stop_spark_simulation").on("click", function (event) {
            $.post("{{ url_for('stop_spark_simulation') }}").done(function (data) {
                console.log("Spark simulation stopped", data);
            }).fail(function (data) {
                console.log("Spark simulation stopped - fail", data);
            });
        });

        $("button#start_kafka_simulation").on("click", function (event) {
            $.post("{{ url_for('start_kafka_simulation') }}").done(function (data) {
                console.log("Kafka simulation started", data);
            }).fail(function (data) {
                console.log("Kafka simulation started - fail", data);
            });
        });

        $("button#stop_kafka_simulation").on("click", function (event) {
            $.post("{{ url_for('stop_kafka_simulation') }}").done(function (data) {
                console.log("Kafka simulation stopped", data);
            }).fail(function (data) {
                console.log("Kafka simulation stopped - fail", data);
            });
        });

        let refreshIntervalHandler = setInterval(checkForUpdates, 3000);
    });

    const background_colors_classes = ["bg-gray-500", "bg-yellow-500", "bg-red-500", "bg-green-500"];
    const text_colors_classes = ["text-gray-400", "text-yellow-400", "text-red-400", "text-green-400"];
    const all_bus_lines = [
        {% for bus_line in bus_lines %}{{ bus_line.bus_line_id }},{% endfor %}
    ];
    function handle_bus_updates(stats) {
        if (stats === undefined) {
            $("#bus-lines-table tbody tr .bus-updates").removeClass(text_colors_classes).addClass("text-gray-400").text("No processing is running");
            return;
        }
        stats.forEach(function (bus_update) {
            const target_msg_cell = $("#bus-line-" + bus_update.bus_line_id + " .bus-updates");
            const target_date_cell = $("#bus-line-" + bus_update.bus_line_id + " .update-time");
            const total_passengers = bus_update["total_passengers"];
            const total_capacity = bus_update["total_capacity"];

            const message = `${total_passengers} passengers / ${total_capacity} capacity .`;
            target_date_cell.text(new Date(bus_update["update_timestamp"]));
            if (bus_update["total_passengers"] > bus_update["total_capacity"]) {
                target_msg_cell.removeClass(text_colors_classes).addClass("text-red-400").text(`${message} Overfilled!!`);
            } else {
                target_msg_cell.removeClass(text_colors_classes).addClass("text-green-400").text(`${message}`);
            }
        });
        const non_reported_bus_lines = stats.map(bus_update => bus_update.bus_line_id).filter(bus_line_id => !all_bus_lines.includes(bus_line_id));
        non_reported_bus_lines.forEach(bus_line_id => {
            $("#bus-line-" + bus_line_id + " .bus-updates").removeClass(text_colors_classes).addClass("text-gray-400").text("No active lines currently.");
            $("#bus-line-" + bus_line_id + " .update-time").text("");
            
        });
    }

    function checkForUpdates() {
        $.get("{{ url_for('spark_status') }}").done(function (updates) {
            handle_bus_updates(updates["stats"])
            switch (updates["status"].toUpperCase()) {
                case "PENDING":
                    $("#spark-status-icon").removeClass(background_colors_classes).addClass("bg-yellow-500");
                    $("#spark-status-message-wrapper").removeClass(text_colors_classes).addClass("text-yellow-400");
                    break;
                case "RUNNING":
                    $("#spark-status-icon").removeClass(background_colors_classes).addClass("bg-green-500");
                    $("#spark-status-message-wrapper").removeClass(text_colors_classes).addClass("text-green-400");
                    break;
                case "ERROR":
                    $("#spark-status-icon").removeClass(background_colors_classes).addClass("bg-red-500");
                    $("#spark-status-message-wrapper").removeClass(text_colors_classes).addClass("text-red-400");
                    break;
                default:
                    $("#spark-status-icon").removeClass(background_colors_classes).addClass("bg-gray-500");
                    $("#spark-status-message-wrapper").removeClass(text_colors_classes).addClass("text-gray-400");
                    break;
            }
            $("#spark-status-message").text(`${updates["message"]} (${updates["status"]})`);
        });
        $.get("{{ url_for('kafka_status') }}").done(function (updates) {
            let extra_message = "";
            switch (updates["status"].toUpperCase()) {
                case "ACTIVE":
                    $("#kafka-status-icon").removeClass(background_colors_classes).addClass("bg-green-500");
                    $("#kafka-status-message-wrapper").removeClass(text_colors_classes).addClass("text-green-400");
                    extra_message = ` Sent ${updates["stats"]["sent_messages"]} out of ${updates["stats"]["total_messages"]}`
                    break;
                case "ERROR":
                    $("#kafka-status-icon").removeClass(background_colors_classes).addClass("bg-red-500");
                    $("#kafka-status-message-wrapper").removeClass(text_colors_classes).addClass("text-red-400");
                    break;
                default:
                    $("#kafka-status-icon").removeClass(background_colors_classes).addClass("bg-gray-500");
                    $("#kafka-status-message-wrapper").removeClass(text_colors_classes).addClass("text-gray-400");
                    break;
            }
            $("#kafka-status-message").text(`${updates["message"]}${extra_message}`);
        });
    }

</script>
{% endblock %}
